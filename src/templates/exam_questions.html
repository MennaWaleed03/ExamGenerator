{% extends "layout.html" %}
{% block content %}

<div class="container py-3" style="max-width: 1100px;">

  <!-- Top bar -->
  <div class="d-flex align-items-center justify-content-between border-bottom pb-3 mb-3 sticky-top bg-body">
    <div>
      <h3 class="m-0">Exam Questions</h3>
      <div class="text-body-secondary small">
        Total questions: <strong>{{ exam_questions|length }}</strong>
      </div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="/courses">Back to Courses</a>
      <a class="btn btn-outline-secondary" href="javascript:history.back()">Back</a>
    </div>
  </div>

  {% if not exam_questions or exam_questions|length == 0 %}
    <div class="alert alert-info">No questions found for this exam.</div>
  {% else %}

    <!-- Controls -->
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <button class="btn btn-sm btn-outline-success" id="btnToggleAnswers" type="button">
        Toggle correct answers
      </button>

      <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-sm btn-outline-dark" id="btnExpandAll" type="button">Expand all</button>
        <button class="btn btn-sm btn-outline-dark" id="btnCollapseAll" type="button">Collapse all</button>
      </div>
    </div>

    <!-- Scroll area -->
    <div class="overflow-auto" style="max-height: calc(150vh - 290px);">

      {% for q in exam_questions %}

        {# normalize enum strings: "XEnum.simple" -> "simple" #}
        {% set diff_text = (q.difficulty ~ '').split('.')[-1] %}
        {% set obj_text  = (q.objective ~ '').split('.')[-1] %}
        {% set diff = diff_text|lower %}
        {% set obj  = obj_text|lower %}

        {% if diff == 'difficult' %}
          {% set diff_badge = 'text-bg-danger' %}
        {% else %}
          {% set diff_badge = 'text-bg-primary' %}
        {% endif %}

        {% if obj == 'remembering' %}
          {% set obj_badge = 'text-bg-info' %}
        {% elif obj == 'understanding' %}
          {% set obj_badge = 'text-bg-warning text-dark' %}
        {% else %}
          {% set obj_badge = 'text-bg-success' %}
        {% endif %}

        <details class="border rounded-3 p-3 mb-2 bg-body" data-q-details>
          <!-- Summary row (click arrow/row to open) -->
          <summary class="d-flex align-items-start justify-content-between gap-2" style="cursor:pointer; list-style:none;">
            <div class="me-2">
              <strong>Q{{ loop.index }}.</strong> {{ q.content }}
              <div class="small text-body-secondary mt-1">
                Updated: <span class="js-date" data-iso="{{ q.updated_at }}">{{ q.updated_at }}</span>
              </div>
            </div>

            <div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
              <span class="badge {{ diff_badge }}">{{ diff_text }}</span>
              <span class="badge {{ obj_badge }}">{{ obj_text }}</span>
              <!-- small arrow (Bootstrap icon replacement) -->
              <span class="text-body-secondary" aria-hidden="true">â–¾</span>
            </div>
          </summary>

          <!-- Choices -->
          <div class="mt-3">
            {% if not q.choices or q.choices|length == 0 %}
              <div class="alert alert-warning mb-0">No choices found for this question.</div>
            {% else %}
              <div class="list-group">
                {% for ch in q.choices %}
                  <div class="list-group-item d-flex align-items-start gap-2">
                    <input class="form-check-input mt-1" type="radio" name="q_{{ q.id }}" disabled>
                    <div class="flex-grow-1">{{ ch.content }}</div>

                    {% if ch.is_correct %}
                      <span class="badge text-bg-success d-none js-correct">Correct</span>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </details>

      {% endfor %}

    </div>
  {% endif %}
</div>

{% endblock content %}

{% block scripts %}
<script src="{{ url_for('static', path='js/exam_questions.js') }}"></script>
{% endblock scripts %}
