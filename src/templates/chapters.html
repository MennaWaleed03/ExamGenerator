{% extends "layout.html" %}
{% block content %}
      <h2 style="text-align: center ;margin-top: 3%; ">{{course_name}} Course</h2>
      <div class="table-responsive" style="max-height: 55vh; overflow-y: auto;">
      <table style="width:98%;" class="mx-auto mt-5 table table-striped table-bordered text-center">
        <thead>
          <tr>
            <th scope="col">Chapter Number</th>
            <th scope="col">Number of questions</th>
            <th scope="col">Last Updated</th>
            <th scope="col">Action</th>
          </tr>
        </thead>

        <tbody>
        {% for chapter in chapters %}
          <tr data-chapter-row-id="{{ chapter.id }}">
            <th scope="row">{{ chapter.chapter_number }}</th>

            <td>
              {{chapter.questions|length}}
            </td>

            <td>{{ chapter.updated_at.strftime('%Y-%m-%d') }}</td>

            <td>
              <!-- VIEW QUESTIONS -->
              <a class="btn btn-primary btn-sm"
                data-bs-toggle="tooltip"
                data-bs-title="View questions"
                href="/chapters/{{ chapter.id }}/questions">
                <i class="bi bi-eye"></i>
              </a>

      <!-- GENERATE QUESTIONS -->
          <a class="btn btn-secondary btn-sm {% if chapter.completed %}disabled{% endif %}"
            data-bs-toggle="tooltip"
            data-bs-title="Add questions"
            data-action="generate-questions"
            data-chapter-id="{{ chapter.id }}"
            data-generate-btn="1"
            href="javascript:void(0)"
            {% if chapter.completed %}
              aria-disabled="true" tabindex="-1"
            {% endif %}> 
            <i class="bi bi-pencil"></i>
          </a>

              <!-- DELETE -->
      <!-- DELETE button (per row) -->
            <button class="btn btn-danger btn-sm"
                    type="button"
                    title="Delete chapter"
                    data-action="delete-chapter"
                    data-chapter-id="{{ chapter.id }}"
                    data-bs-toggle="modal"
                    data-bs-target="#deleteChapterModal">
              <i class="bi bi-trash"></i>
            </button>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="4" class="text-center text-muted">
              No chapters for this course yet.
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      </div>
    <!-- Floating Add Chapter -->
    <a href="javascript:void(0)"
      class="ms-5 mt-3 btn btn-primary rounded-circle position-fixed d-flex align-items-center justify-content-center shadow fab-create-course"
      data-bs-toggle="tooltip"
      data-bs-title="Add Chapter"
      data-action="add-chapter"
      data-course-id="{{ course_id }}">
      <i class="bi bi-plus-lg fs-4"></i>
    </a>
<!-- Delete Chapter Modal  -->
      <div class="modal fade" id="deleteChapterModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">

            <div class="modal-header">
              <h5 class="modal-title text-danger">Delete Chapter</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <input type="hidden" id="deleteChapterId" value="">
              <p class="mb-0">Are you sure you want to delete this chapter?</p>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                Close
              </button>

              <button type="button" class="btn btn-danger" id="confirmDeleteChapterBtn">
                Delete
              </button>
            </div>

          </div>
        </div>
      </div>
<!-- Add Questions Modal -->
<div class="modal fade" id="AddQuestionsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Add Questions</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form id="addQuestionsForm" novalidate>
        <div class="modal-body">

          <!-- Add button -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="text-muted">
              Add up to <b>50</b> questions.
            </div>

            <button type="button" class="btn btn-outline-primary" id="btnAddQuestion">
              <i class="bi bi-plus-circle"></i> Add question
            </button>
          </div>

          <!-- Where question cards will be appended -->
          <div id="questionsContainer"></div>

          <!-- Template (hidden) -->
          <template id="questionCardTemplate">
            <div class="card mb-3 question-card" data-q-index="">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div class="fw-semibold">
                  Question <span class="q-number"></span>
                </div>

                <button type="button" class="btn btn-sm btn-outline-danger btnRemoveQuestion" title="Remove">
                  <i class="bi bi-dash-circle"></i>
                </button>
              </div>

              <div class="card-body">

                <!-- (Recommended) metadata your API needs -->
                <div class="row g-2 mb-3">
                  <div class="col-md-6">
                    <label class="form-label">Difficulty</label>
                    <select class="form-select q-difficulty" required>
                      <option value="simple" selected>Simple</option>
                      <option value="difficult">Difficult</option>
                    </select>
                    <div class="invalid-feedback">Choose difficulty.</div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Objective</label>
                    <select class="form-select q-objective" required>
                      <option value="remembering" selected>Remembering</option>
                      <option value="understanding">Understanding</option>
                      <option value="creativity">Creativity</option>
                    </select>
                    <div class="invalid-feedback">Choose objective.</div>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Question content</label>
                  <input type="text" class="form-control q-text" placeholder="Write the question here..." required>
                  <div class="invalid-feedback">Question content is required.</div>
                </div>

                <div class="mb-2">
                  <label class="form-label">Choices (select the correct one)</label>

                  <div class="input-group mb-2">
                    <div class="input-group-text">
                      <input class="form-check-input mt-0 q-correct" type="radio" value="A" required>
                    </div>
                    <span class="input-group-text">A</span>
                    <input type="text" class="form-control q-choice" data-choice="A" placeholder="Choice A" required>
                    <div class="invalid-feedback">Choice A is required.</div>
                  </div>

                  <div class="input-group mb-2">
                    <div class="input-group-text">
                      <input class="form-check-input mt-0 q-correct" type="radio" value="B" required>
                    </div>
                    <span class="input-group-text">B</span>
                    <input type="text" class="form-control q-choice" data-choice="B" placeholder="Choice B" required>
                    <div class="invalid-feedback">Choice B is required.</div>
                  </div>

                  <div class="input-group mb-2">
                    <div class="input-group-text">
                      <input class="form-check-input mt-0 q-correct" type="radio" value="C" required>
                    </div>
                    <span class="input-group-text">C</span>
                    <input type="text" class="form-control q-choice" data-choice="C" placeholder="Choice C" required>
                    <div class="invalid-feedback">Choice C is required.</div>
                  </div>

                  <div class="form-text text-muted">
                    Make sure to pick the correct choice.
                  </div>
                </div>

              </div>
            </div>
          </template>

        </div>

        <div class="modal-footer">
          <button type="button" id="discardQuestionsBtn" class="btn btn-outline-danger">Discard</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>

      </form>

    </div>
  </div>
</div>
<!-- Floating Generate Exam (bottom-left) -->
  <button type="button"
    class="btn btn-primary position-fixed shadow"
    style="left: 350px; bottom: 50px; z-index: 1050; border-radius: 999px; padding: 10px 16px;"
    id="btnOpenGenerateExamModal"
    data-bs-toggle="tooltip"
    data-bs-title="Generate an exam for this course">
    <i class="bi bi-file-earmark-text me-1"></i>
    Generate Exam
  </button>

  <!-- Generate Exam Modal (constraints) -->
  <div class="modal fade" id="generateExamModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Generate Exam</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <form id="generateExamForm" class="needs-validation" novalidate>
          <div class="modal-body">

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Questions per chapter</label>
                <input type="number" class="form-control" name="questions_per_chapter" min="1" step="1" required>
                <div class="invalid-feedback">Required (min 1).</div>
              </div>

              <div class="col-md-6">
                <div class="alert alert-secondary mb-0" id="examTotalsBox">
                  <div class="fw-semibold">Required total questions:</div>
                  <div class="mt-1">
                    <span id="requiredTotalText" class="fw-bold">0</span>
                    <span class="text-muted">(questions_per_chapter Ã— chapters)</span>
                  </div>

                  <div class="mt-2 small">
                    <div>Difficulty total: <span id="difficultyTotalText">0</span></div>
                    <div>Objective total: <span id="objectiveTotalText">0</span></div>
                  </div>

                  <div class="mt-2 small d-none text-danger" id="totalsMismatchText"></div>
                </div>
              </div>

              <div class="col-12"><hr class="my-2"></div>

              <div class="col-md-6">
                <label class="form-label">Difficult questions</label>
                <input type="number" class="form-control" name="difficult_questions" min="0" step="1" required>
                <div class="invalid-feedback">Required.</div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Simple questions</label>
                <input type="number" class="form-control" name="simple_questions" min="0" step="1" required>
                <div class="invalid-feedback">Required.</div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Remembering questions</label>
                <input type="number" class="form-control" name="remembering_questions" min="0" step="1" required>
                <div class="invalid-feedback">Required.</div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Understanding questions</label>
                <input type="number" class="form-control" name="understanding_questions" min="0" step="1" required>
                <div class="invalid-feedback">Required.</div>
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label">Creative questions</label>
                <input type="number" class="form-control" name="creative_questions" min="0" step="1" required>
                <div class="invalid-feedback">Required.</div>
              </div>

              <div class="col-12">
                <div class="text-danger small d-none" id="generateExamError"></div>
              </div>
            </div> 

          </div> 

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-success" id="btnGenerateExamSubmit">
              <span class="me-1">Generate</span>
              <span class="spinner-border spinner-border-sm d-none" id="generateExamSpinner"></span>
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
<!-- Generated Exam Modal -->
<div class="modal fade" id="generatedExamModal" tabindex="-1" aria-hidden="true" >
  <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <div>
          <h5 class="modal-title mb-0">Generated Exam</h5>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div id="generatedExamSummary" class="mb-3"></div>
          <div id="generatedExamBody"></div>
          <div class="mt-2 text-danger small d-none" id="generatedExamError">
        </div>
        
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" id="btnRegenerateExam">
          <i class="bi bi-arrow-repeat me-1"></i> Regenerate
        </button>
        <button type="button" class="btn btn-primary" id="btnSaveExam">
          <i class="bi bi-check2-circle me-1"></i> Save
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

{% endblock content %}

{% block scripts %}
<script>
  window.__courseId = {{ course_id | tojson }};
  window.__totalChapters = {{ number_of_chapters}};
</script>
<script src="{{ url_for('static', path='js/chapters.js') }}"></script>
<script src="{{ url_for('static', path='js/generate_exam.js') }}"></script>
<script>
  window.addEventListener("pageshow", (e) => {
    // If the page is restored from cache, reload to show updated counts
    if (e.persisted) window.location.reload();
  });
</script>
{% endblock scripts %}
